version: 2.1

jobs:
  build:
    docker:
      - image: devago/docker-compose
    environment:
      REGISTRY_HOST: harbor.dsrd.libraries.psu.edu
      REGISTRY_URL: harbor.dsrd.libraries.psu.edu/library/scholarsphere-metadata-listener
      DOCKER_USERNAME: 'robot$circleci'
    steps:
    - setup_remote_docker:
        version: 18.09.3
    - checkout
    - run:
        name: "Start Dependencies"
        background: true
        command: |
          docker-compose pull minio 
          docker-compose up -d minio 
    - run:
        name: "Build Docker Container"
        command: |
          docker build -t $REGISTRY_URL:$CIRCLE_SHA1 .
    - run:
        name: "Niftany"
        command: |
          docker run $REGISTRY_URL:$CIRCLE_SHA1 /app/bin/niftany
    - run:
        name: "RSpec"
        command: |
          docker run\
            -e CC_TEST_REPORTER_ID=${CC_TEST_REPORTER_ID}\
            -e GIT_COMMIT_SHA=${CIRCLE_SHA1}\
            -e GIT_BRANCH=${CIRCLE_BRANCH}\
            -e S3_ENDPOINT=http://minio:9000\
            -e AWS_BUCKET=listener\
            -e AWS_ACCESS_KEY_ID=listener\
            -e AWS_SECRET_ACCESS_KEY=listener\
            $REGISTRY_URL:$CIRCLE_SHA1 /app/bin/rspec-ci
    - run:
        name: "Publishing the image"
        command: |
          docker build -t $REGISTRY_URL:$CIRCLE_SHA1 .
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $REGISTRY_HOST
          docker push $REGISTRY_URL:$CIRCLE_SHA1

workflows:
  version: 2
  metadata:
    jobs:
      - build
